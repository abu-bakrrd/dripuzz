#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ PostgreSQL –Ω–∞ VPS
# –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ –ë–î —Å –≤–∞—à–µ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ (Windows/Mac)

set -e

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞"
echo "=============================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ root
if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å sudo"
    exit 1
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ä—Å–∏—é PostgreSQL
PG_VERSION=$(psql --version | grep -oP '\d+' | head -1)
echo "üì¶ –û–±–Ω–∞—Ä—É–∂–µ–Ω PostgreSQL –≤–µ—Ä—Å–∏–∏: $PG_VERSION"

# –ü—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º
PG_CONF="/etc/postgresql/$PG_VERSION/main/postgresql.conf"
PG_HBA="/etc/postgresql/$PG_VERSION/main/pg_hba.conf"

echo ""
echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï!"
echo "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –æ—Ç–∫—Ä–æ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ PostgreSQL –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞."
echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –°–ò–õ–¨–ù–´–ô –ø–∞—Ä–æ–ª—å –¥–ª—è –ë–î!"
echo ""
read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ"
    exit 0
fi

echo ""
echo "üîß –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ postgresql.conf..."

# –ë—ç–∫–∞–ø –∫–æ–Ω—Ñ–∏–≥–∞
cp "$PG_CONF" "$PG_CONF.backup.$(date +%Y%m%d_%H%M%S)"
echo "‚úÖ –°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø: $PG_CONF.backup.*"

# –†–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∞–¥—Ä–µ—Å–æ–≤
if grep -q "^listen_addresses" "$PG_CONF"; then
    sed -i "s/^listen_addresses.*/listen_addresses = '*'/" "$PG_CONF"
else
    echo "listen_addresses = '*'" >> "$PG_CONF"
fi

echo "‚úÖ PostgreSQL –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å –≤—Å–µ –∞–¥—Ä–µ—Å–∞"

echo ""
echo "üîß –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ pg_hba.conf..."

# –ë—ç–∫–∞–ø
cp "$PG_HBA" "$PG_HBA.backup.$(date +%Y%m%d_%H%M%S)"
echo "‚úÖ –°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø: $PG_HBA.backup.*"

# –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
if ! grep -q "# Allow remote connections" "$PG_HBA"; then
    echo "" >> "$PG_HBA"
    echo "# Allow remote connections" >> "$PG_HBA"
    echo "host    all             all             0.0.0.0/0               md5" >> "$PG_HBA"
    echo "‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π"
else
    echo "‚ö†Ô∏è  –ü—Ä–∞–≤–∏–ª–æ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

echo ""
echo "üîß –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall (ufw)..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ ufw
if command -v ufw &> /dev/null; then
    # –†–∞–∑—Ä–µ—à–∞–µ–º –ø–æ—Ä—Ç 5432
    ufw allow 5432/tcp
    echo "‚úÖ –ü–æ—Ä—Ç 5432 –æ—Ç–∫—Ä—ã—Ç –≤ firewall"
else
    echo "‚ö†Ô∏è  ufw –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É firewall"
fi

echo ""
echo "üîß –®–∞–≥ 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PostgreSQL..."
systemctl restart postgresql
echo "‚úÖ PostgreSQL –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"

echo ""
echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìã –í–∞—à–∞ —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞:"
echo ""

# –ü–æ–ª—É—á–∞–µ–º IP –∞–¥—Ä–µ—Å VPS
VPS_IP=$(hostname -I | awk '{print $1}')

# –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ë–î –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ
read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö [shop_db]: " DB_NAME
DB_NAME=${DB_NAME:-shop_db}

read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î [shop_user]: " DB_USER
DB_USER=${DB_USER:-shop_user}

echo ""
echo "DATABASE_URL=postgresql://$DB_USER:–í–ê–®_–ü–ê–†–û–õ–¨@$VPS_IP:5432/$DB_NAME"
echo ""
echo "üîê –ó–∞–º–µ–Ω–∏—Ç–µ '–í–ê–®_–ü–ê–†–û–õ–¨' –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –æ—Ç –ë–î!"
echo ""
echo "üìù –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É –≤ —Ñ–∞–π–ª telegram_bot/.env –Ω–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ"
echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û –î–õ–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò:"
echo "1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –°–ò–õ–¨–ù–´–ô –ø–∞—Ä–æ–ª—å –¥–ª—è –ë–î"
echo "2. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ —Ç–æ–ª—å–∫–æ —Å –≤–∞—à–µ–≥–æ IP"
echo "3. –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —Å–∏—Å—Ç–µ–º—É: sudo apt update && sudo apt upgrade"
echo ""
echo "üß™ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –≤–∞—à–µ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞:"
echo "psql \"postgresql://$DB_USER:–ü–ê–†–û–õ–¨@$VPS_IP:5432/$DB_NAME\""
