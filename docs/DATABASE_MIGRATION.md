# Миграция базы данных на новый VPS

Это руководство описывает процесс переноса базы данных PostgreSQL со старого VPS сервера на новый.

## Содержание

1. [Подготовка](#подготовка)
2. [Создание бэкапа на старом сервере](#создание-бэкапа-на-старом-сервере)
3. [Перенос на новый сервер](#перенос-на-новый-сервер)
4. [Восстановление базы данных](#восстановление-базы-данных)
5. [Автоматические бэкапы](#автоматические-бэкапы)
6. [Решение проблем](#решение-проблем)

---

## Подготовка

Перед миграцией убедитесь, что:

- [ ] На старом сервере установлены скрипты `backup_db.sh` и `restore_db.sh`
- [ ] На новом сервере развёрнуто приложение (через `master_deploy.sh`)
- [ ] У вас есть SSH доступ к обоим серверам

## Создание бэкапа на старом сервере

### Шаг 1: Подключитесь к старому серверу

```bash
ssh root@СТАРЫЙ_IP
```

### Шаг 2: Создайте резервную копию

```bash
cd /home/shopapp/app
./backup_db.sh
```

Вы увидите вывод:

```
[BACKUP] Создание резервной копии базы данных shopdb...
[BACKUP] Сжатие резервной копии...
[BACKUP] ✅ Резервная копия создана: /home/shopapp/app/backups/backup_20241129_143000.sql.gz
[BACKUP] Размер: 2.5M
```

### Шаг 3: Проверьте созданный файл

```bash
ls -lh /home/shopapp/app/backups/
```

Файл бэкапа имеет формат: `backup_YYYYMMDD_HHMMSS.sql.gz`

---

## Перенос на новый сервер

### Вариант 1: Через локальный компьютер

**На локальном компьютере:**

```bash
# Скачать бэкап со старого сервера
scp root@СТАРЫЙ_IP:/home/shopapp/app/backups/backup_*.sql.gz ./

# Загрузить на новый сервер
scp backup_*.sql.gz root@НОВЫЙ_IP:/home/shopapp/app/backups/
```

### Вариант 2: Напрямую между серверами

**На старом сервере:**

```bash
scp /home/shopapp/app/backups/backup_*.sql.gz root@НОВЫЙ_IP:/home/shopapp/app/backups/
```

---

## Восстановление базы данных

### Шаг 1: Подключитесь к новому серверу

```bash
ssh root@НОВЫЙ_IP
```

### Шаг 2: Запустите восстановление

```bash
cd /home/shopapp/app
sudo ./restore_db.sh
```

### Шаг 3: Выберите бэкап из списка

Скрипт покажет доступные бэкапы:

```
[RESTORE] Доступные резервные копии:

1) /home/shopapp/app/backups/backup_20241129_143000.sql.gz (2.5M)
2) /home/shopapp/app/backups/backup_20241128_120000.sql.gz (2.4M)

Введите номер резервной копии для восстановления (или путь к файлу): 1
```

### Шаг 4: Подтвердите восстановление

```
⚠️  ВНИМАНИЕ! Это действие ПЕРЕЗАПИШЕТ текущую базу данных: shopdb
Все текущие данные будут удалены!

Вы уверены? Введите 'yes' для продолжения: yes
```

### Что делает скрипт восстановления:

1. Создаёт страховочную копию текущей БД
2. Останавливает приложение
3. Восстанавливает данные во временную БД
4. Переключает на восстановленную БД
5. Запускает приложение
6. При ошибке — автоматически откатывает изменения

---

## Автоматические бэкапы

### Настройка ежедневных бэкапов через cron

```bash
sudo crontab -e
```

Добавьте строку для ежедневного бэкапа в 3:00 ночи:

```cron
0 3 * * * /home/shopapp/app/backup_db.sh >> /var/log/backup.log 2>&1
```

### Проверка работы cron

```bash
# Посмотреть список задач
sudo crontab -l

# Проверить логи бэкапов
tail -f /var/log/backup.log
```

---

## Решение проблем

### Ошибка: "Файл .env не найден"

Убедитесь, что файл `.env` существует и содержит `DATABASE_URL`:

```bash
cat /home/shopapp/app/.env
```

Если файла нет, создайте его:

```bash
nano /home/shopapp/app/.env
```

Добавьте:

```env
DATABASE_URL=postgresql://shop_user:ВАШ_ПАРОЛЬ@localhost:5432/shopdb
```

### Ошибка: "Permission denied"

Запускайте скрипты с правами root:

```bash
sudo ./restore_db.sh
```

### Ошибка подключения к базе данных

Проверьте статус PostgreSQL:

```bash
sudo systemctl status postgresql
```

Если не запущен:

```bash
sudo systemctl start postgresql
```

### Приложение не запускается после восстановления

1. Проверьте логи:

   ```bash
   sudo journalctl -u shop-app -n 50
   ```

2. Скрипт автоматически откатит изменения при ошибке

3. Страховочная копия сохранена в `/home/shopapp/app/backups/before_restore_*.sql.gz`

---

## Полезные команды

### Ручное создание бэкапа без скрипта

```bash
sudo -u postgres pg_dump shopdb | gzip > backup_manual.sql.gz
```

### Ручное восстановление без скрипта

```bash
gunzip -c backup_manual.sql.gz | sudo -u postgres psql shopdb
```

### Просмотр размера базы данных

```bash
sudo -u postgres psql -c "SELECT pg_size_pretty(pg_database_size('shopdb'));"
```

### Список таблиц в базе

```bash
sudo -u postgres psql -d shopdb -c "\dt"
```

---

## Рекомендации

1. **Делайте бэкапы регулярно** — настройте cron для ежедневных бэкапов
2. **Храните бэкапы в нескольких местах** — например, на локальном компьютере или в облаке
3. **Проверяйте бэкапы** — периодически тестируйте восстановление на тестовом сервере
4. **Очищайте старые бэкапы** — скрипт автоматически оставляет последние 30 бэкапов
